#!/bin/bash
#
# bandit_database - BANDIT database functions
#
# Copyright (C) 2016-2017 Angel Linares Zapater
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License, version 2, as 
# published by the Free Software Foundation. See the COPYING file.
#
# This program is distributed WITHOUT ANY WARRANTY; without even the 
# implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  
#

#---
# Catalog database 
#---

#---
# Bundles database 
#---

# Get available bundles 
bandit_db_get_bundles_available()
{
  local _retvar=$1
  local _prefix=$2

  local _list=$(find $BANDIT_HOME/etc/bundles -name *${_prefix}*.desc | sort)

  eval $_retvar="'$_list'"
}

#---
# Items database 
#---

# Get available bundles 
bandit_db_get_bundle_items_available()
{
  local _retvar=$1
  local _expr=$2

  local _list=$(
      grep -e "${expr}" $BANDIT_HOME/etc/bundles/*.desc |
      sed -e "/#/d" -e "s/'//g" | 
      awk '{
            bundle=$1
            sub(/.package/,"",bundle)  
            sub(/.script/, "",bundle)  
            item=$3 
            variant=$5
            print bundle"|"item"|"variant
           }' 
      ) 

  eval $_retvar="'$_list'"
}

#---
# Packages database 
#---

# Get porg files for an installed package
bandit_db_get_package_files()
{
    porg -f $1
}

# Get porg info for an installed package
bandit_db_get_package_info()
{
    porg -i $1
}

# Get available packages in downloaded bundles
bandit_db_get_packages_available()
{
  local _retvar=$1
  local _prefix=$2

  local _list=$(find $BANDIT_HOME/etc/bundles -name ${_prefix}.sh)

  eval $_retvar="'$_list'"
}

# Get packages installed with bandit
bandit_db_get_packages_installed()
{
  local _retvar=$1
  local _prefix=$2

  local _list=$(find /var/log/porg -name ${_prefix})

  eval $_retvar="'$_list'"
}

#---
# Files database 
#---

# Get installed files 
bandit_db_get_files_installed()
{
  local _retvar=$1
  local _prefix=$2

  local _list=$(grep -R ${_prefix} /var/log/porg | 
      sed -e "/#/d" -e "s/[:|]/ /g" | 
      awk '{
            package=$1
            file=$2
            print file"|"package
           }' |
      sort
      ) 

  eval $_retvar="'$_list'"
}

#---
# Cache database 
#---

# Get cached sources
bandit_db_get_cache_sources()
{
  local _retvar=$1
  local _prefix=$2

  local _list=$(find $BANDIT_ORIG -name "*${_prefix}*" | sort -d) 

  eval $_retvar="'$_list'"
}

# Get cached builds
bandit_db_get_cache_builds()
{
  local _retvar=$1
  local _prefix=$2

  local _list=$(find $BANDIT_DEST -name "*${_prefix}*" | sort -d) 

  eval $_retvar="'$_list'"
}


#---
# Logs database 
#---

# Get log entries
bandit_db_get_log_entries()
{
  local _retvar=$1
  local _prefix=$2

  local _list=$(find $BANDIT_LOGS -type f -name "*${_prefix}*" | 
      sed -e "s#${BANDIT_LOGS}/bundles/##g" -e "s/.log$//g" | 
      awk -F '/' '{
            match($1, /[0-9]+-[0-9]+.[0-9]+/)
            timestamp=substr($1, RSTART, RLENGTH)
            bundle=substr($1, 1, RSTART-2)
            print timestamp"|"bundle"|"$2
           }' |
      sort -d) 

  eval $_retvar="'$_list'"
}


#### NOT USED ?

bandit_db_package_is_installed()
{
  if [ "$(porg $1)" == "" ]; then
      return 0
  else
      return 1
  fi
}

bandit_db_get_package_bundles()
{
  local _retvar=$1
  local _package=$2

  local _list=$(find $BANDIT_HOME/etc/bundles -name ${_package})

  local _bundles
  _bundles=($_bundles $(basename $(dirname ${_list})))

  eval $_retvar="'$_bundles'"
}
